<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pam Lang Customer Work Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 30px 0px 30px;
            text-align: center;
        }
        
        .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            margin-bottom: 25px;
        }
        
        .header-info {
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.4rem;
            margin-bottom: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header-actions {
            background: rgba(255,255,255,0.15);
            padding: 18px 30px;
            margin: 0 -30px;
            border-top: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .header-btn {
            padding: 8px 14px;
            background: rgba(255,255,255,0.9);
            border: 2px solid rgba(255,255,255,1);
            border-radius: 8px;
            color: #2d3748;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        
        .header-btn:hover {
            background: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border-color: white;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
        }
        
        .tab-button:hover {
            background: #edf2f7;
            color: #2d3748;
        }
        
        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-button .close-btn {
            margin-left: 10px;
            background: #e2e8f0;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            color: #718096;
        }
        
        .tab-button .close-btn:hover {
            background: #cbd5e0;
            color: #2d3748;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            min-height: 600px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-grid {
            display: flex;
            flex-direction: column;
            gap: 25px;
            padding: 30px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #e0e6ed;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .full-width-card {
            width: 100%;
        }
        
        .callback-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .callback-table th {
            background: #f8fafc;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.85rem;
        }
        
        .callback-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f4f8;
            vertical-align: middle;
        }
        
        .callback-table tr:hover {
            background: #f8fafc;
        }
        
        .callback-table tr:last-child td {
            border-bottom: none;
        }
        
        .callback-customer-name {
            font-weight: 600;
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
        }
        
        .callback-customer-name:hover {
            color: #5a67d8;
            text-decoration: underline;
        }
        
        .callback-org-small {
            color: #718096;
            font-size: 0.8rem;
        }
        
        .callback-reason-small {
            color: #4a5568;
            font-style: italic;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .btn-done {
            padding: 4px 8px;
            font-size: 0.75rem;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-done:hover {
            background: #38a169;
            transform: translateY(-1px);
        }
        
        .attention-item {
            display: grid;
            grid-template-columns: 200px 1fr 120px;
            gap: 20px;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f4f8;
        }
        
        .attention-item:last-child {
            border-bottom: none;
        }
        
        .attention-customer {
            font-weight: 600;
            color: #2d3748;
        }
        
        .attention-note {
            color: #4a5568;
            background: #fef5e7;
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid #dd6b20;
        }
        
        .priority-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
        }
        
        .priority-urgent { background: #fed7d7; color: #c53030; }
        .priority-high { background: #fef5e7; color: #dd6b20; }
        .priority-normal { background: #e6fffa; color: #38a169; }
        
        .add-attention-form {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #e2e8f0;
            margin-top: 15px;
        }
        
        .add-form-grid {
            display: grid;
            grid-template-columns: 200px 1fr 120px auto;
            gap: 15px;
            align-items: end;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f4f8;
        }
        
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
            color: white;
        }
        
        .today-callbacks .card-icon { background: linear-gradient(135deg, #ff6b6b, #ff8e53); }
        .urgent-trials .card-icon { background: linear-gradient(135deg, #ffecd2, #fcb69f); color: #d63031; }
        .recent-activity .card-icon { background: linear-gradient(135deg, #a8edea, #fed6e3); color: #00b894; }
        .quick-actions .card-icon { background: linear-gradient(135deg, #d299c2, #fef9d7); color: #6c5ce7; }
        
        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .customer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f4f8;
        }
        
        .customer-item:last-child {
            border-bottom: none;
        }
        
        .customer-info h4 {
            color: #2d3748;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .customer-info p {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .trial-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .urgent { background: #fed7d7; color: #c53030; }
        .warning { background: #fef5e7; color: #dd6b20; }
        .normal { background: #e6fffa; color: #38a169; }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.8rem;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-new { background: #48bb78; }
        .status-called { background: #ed8936; }
        .status-email-sent { background: #4299e1; }
        .status-converted { background: #38a169; }
        .status-callback-scheduled { background: #805ad5; }

        /* Customer Search View Styles */
        .customer-search-view {
            padding: 30px;
            background: #f8fafc;
        }
        
        .search-header {
            margin-bottom: 25px;
        }
        
        .search-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: start;
        }
        
        .search-filters {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            align-items: center;
        }
        
        .search-input {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filter-dropdown {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .filter-dropdown:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .sort-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }
        
        .sort-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .sort-label {
            font-weight: 500;
            color: #4a5568;
            min-width: 80px;
            font-size: 0.9rem;
        }
        
        .sort-controls {
            display: flex;
            gap: 4px;
        }
        
        .sort-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .sort-btn:hover {
            border-color: #667eea;
            background: #f8fafc;
        }
        
        .sort-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .sort-btn.active:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        
        .customer-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .customer-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .customer-table th {
            background: #f8fafc;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .customer-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f4f8;
            vertical-align: middle;
        }
        
        .customer-table tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .customer-table tr:hover {
            background: #f8fafc;
        }
        
        .customer-table tr:last-child td {
            border-bottom: none;
        }
        
        .table-customer-name {
            font-weight: 600;
            color: #2d3748;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .table-organization {
            color: #718096;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .table-email {
            color: #4a5568;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .table-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .table-trial-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .table-date {
            color: #718096;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* Customer Edit Form Styles */
        .customer-edit-view {
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .edit-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .edit-title {
            font-size: 2rem;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .edit-subtitle {
            font-size: 1.1rem;
            color: #718096;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .form-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s ease;
            min-height: 100px;
            resize: vertical;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .follow-up-section {
            grid-column: 1 / -1;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
        }
        
        .follow-up-item {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .follow-up-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .follow-up-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
        }
        
        .follow-up-date {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            padding: 20px 0;
            border-top: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
        }

        /* Reports Dashboard Styles */
        .reports-view {
            padding: 30px;
            background: #f8fafc;
        }
        
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .reports-title {
            font-size: 2rem;
            color: #2d3748;
            margin: 0;
        }
        
        .reports-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .reports-grid {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        /* Key Metrics Row */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
        }
        
        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .metric-content {
            flex: 1;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            line-height: 1;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #718096;
            margin: 5px 0;
        }
        
        .metric-change {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .metric-change.positive {
            color: #38a169;
        }
        
        .metric-change.negative {
            color: #e53e3e;
        }
        
        .success-rate {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .success-rate.high {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .success-rate.medium {
            background: #fef5e7;
            color: #744210;
        }
        
        .success-rate.low {
            background: #fed7d7;
            color: #742a2a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-info">
                    <h1>üéØ Pam's Customer Work Center</h1>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn" onclick="refreshDashboard()">üîÑ Refresh</button>
                <button class="header-btn" onclick="switchView('allcustomers')">üë• All Customers</button>
                <button class="header-btn" onclick="switchView('hitlist')">üî• Hit List</button>
                <button class="header-btn" onclick="switchView('targetleads')">üìß Target Leads</button>
                <button class="header-btn" onclick="addNewCustomer()">‚ûï Add Customer</button>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('dashboard')" id="tab-dashboard">
                üè† Dashboard
            </button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="dashboard-grid">
                <!-- Today's Callbacks - Full Width -->
                <div class="card full-width-card today-callbacks">
                    <div class="card-header">
                        <div class="card-icon">üìÖ</div>
                        <div class="card-title">Today's Callbacks</div>
                    </div>
                    <div id="todaysCallbacks" class="loading">
                        Loading today's scheduled callbacks...
                    </div>
                </div>
                
                <!-- Needs Attention - Full Width -->
                <div class="card full-width-card urgent-trials">
                    <div class="card-header">
                        <div class="card-icon">üö®</div>
                        <div class="card-title">Needs Attention</div>
                    </div>
                    <div id="needsAttention">
                        <div class="add-attention-form">
                            <h4 style="margin-bottom: 15px; color: #2d3748;">Add Attention Item</h4>
                            <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: end;">
                                <div>
                                    <label class="form-label" style="margin-bottom: 5px;">Who/What:</label>
                                    <input type="text" 
                                           class="form-input" 
                                           id="attention-subject-input" 
                                           placeholder="Customer name, person, or topic..."
                                           list="customer-suggestions-list">
                                    <datalist id="customer-suggestions-list"></datalist>
                                </div>
                                <div>
                                    <label class="form-label" style="margin-bottom: 5px;">Reminder:</label>
                                    <input type="text" class="form-input" id="attention-note-input" placeholder="What needs attention? (e.g., 'Talk to Steve about Monday off', 'Call about pricing')">
                                </div>
                                <button class="btn btn-small" onclick="addAttentionItem()" style="margin-top: 20px;">+ Add</button>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem; color: #1e40af;">
                                üí° <strong>Tip:</strong> Type a customer name from your database for customer-specific reminders, or enter anything else for general notes (like "Buy groceries", "Call dentist", etc.)
                            </div>
                        </div>
                        <div id="attentionItems"></div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="card recent-activity">
                    <div class="card-header">
                        <div class="card-icon">üîÑ</div>
                        <div class="card-title">Recent Activity</div>
                    </div>
                    <div id="recentActivity" class="loading">
                        Loading recent customer interactions...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://gnpzqjmeiusniabmxomt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImducHpxam1laXVzbmlhYm14b210Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3Nzc1NDAsImV4cCI6MjA2MzM1MzU0MH0.JnL0eLrvcJ3Fo2eEkMM9pHvX6VKfJmgxy9gJNEnV_84';
        const USER_TELEGRAM_ID = '6285585111';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Utility functions first
        function getTodayLocalDate() {
            // Get today's date in user's local timezone (Pacific Time)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Customer data - will be loaded from Supabase
        let allCustomers = [];
        
        // Load customers from Supabase database
        async function loadCustomersFromDatabase() {
            try {
                console.log('Loading customers from Supabase...');
                
                const { data, error } = await supabase
                    .from('wildapricot_customer_calls')
                    .select('*')
                    .eq('user_telegram_id', USER_TELEGRAM_ID)
                    .order('updated_at', { ascending: false });
                
                if (error) {
                    console.error('Supabase error:', error);
                    alert('Error loading customers from database: ' + error.message);
                    return;
                }
                
                console.log(`Loaded ${data.length} customers from database`);
                allCustomers = data;
                
                // Re-split data and refresh display
                splitCustomersByLeadSource();
                loadDashboardData();
                
                // Also refresh other views if they're active
                if (currentView === 'hitlist') {
                    loadHitList();
                } else if (currentView === 'targetleads') {
                    loadTargetLeads();
                } else if (currentView === 'allcustomers') {
                    loadAllCustomers();
                }
                
            } catch (error) {
                console.error('Failed to load customers:', error);
                alert('Failed to connect to database. Using demo data.');
                
                // Fallback to demo data if connection fails
                allCustomers = [
                    {"id":118,"customer_name":"DALAL, ALSHUN","email_address":"dalal.alshun@laverne.edu","organization_name":"Nails Please","trial_days_remaining":59,"call_status":"callback_scheduled","updated_at":"2025-06-18T21:08:54.153925+00:00","trial_expiration_date":"2025-08-16","zendesk_url":"https://personifycorp.zendesk.com/agent/tickets/1783294/requester/requested_tickets","hubspot_url":"https://app.hubspot.com/contacts/7302225/record/0-1/101199996692/properties","wildapricot_site_url":"https://nailsplease.wildapricot.org/","lead_source":"inbound_call","phone_number":"9492879564","call_outcome":"Account #497362 - Trial started June 17, 2025","industry_type":null,"next_callback_date":"2025-06-18","callback_reason":"Follow up on trial setup and answer any initial questions"},
                    {"id":201,"customer_name":"Lead - Tech Nonprofit","email_address":"contact@technonprofit.org","organization_name":"Tech for Good Nonprofit","call_status":"new","updated_at":"2025-06-15T10:00:00.000000+00:00","lead_source":"target_leads","industry_type":"nonprofit"}
                ];
                splitCustomersByLeadSource();
                loadDashboardData();
            }
        }
        
        // Separate data arrays for each view
        let hitListCustomers = [];
        let targetLeadsCustomers = [];
        let filteredHitList = [];
        let filteredTargetLeads = [];
        let filteredAllCustomers = [];
        
        // Filter and sort state
        let nameSearchTerm = '';
        let trialDateFilter = '';
        let lastContactFilter = '';
        let currentSortField = null;
        let currentSortDirection = 'desc';
        
        // Tab management - only for customer edit tabs now
        let openTabs = ['dashboard'];
        let activeTab = 'dashboard';
        let currentView = 'dashboard'; // dashboard, allcustomers, hitlist, targetleads

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Customer Work Center...');
            
            // Load customers from Supabase database
            loadCustomersFromDatabase();
            
            setupSearchHandlers();
        });

        // Main view switching (header buttons)
        function switchView(viewName) {
            currentView = viewName;
            
            // Update dashboard content based on view
            const dashboardTab = document.getElementById('dashboard-tab');
            
            if (viewName === 'dashboard') {
                dashboardTab.innerHTML = createDashboardContent();
                loadDashboardData();
            } else if (viewName === 'allcustomers') {
                dashboardTab.innerHTML = createAllCustomersContent();
                loadAllCustomers();
            } else if (viewName === 'hitlist') {
                dashboardTab.innerHTML = createHitListContent();
                loadHitList();
            } else if (viewName === 'targetleads') {
                dashboardTab.innerHTML = createTargetLeadsContent();
                loadTargetLeads();
            }
        }

        // Content creators for each view
        function createDashboardContent() {
            return `
                <div class="dashboard-grid">
                    <!-- Today's Callbacks - Full Width -->
                    <div class="card full-width-card today-callbacks">
                        <div class="card-header">
                            <div class="card-icon">üìÖ</div>
                            <div class="card-title">Today's Callbacks</div>
                        </div>
                        <div id="todaysCallbacks" class="loading">
                            Loading today's scheduled callbacks...
                        </div>
                    </div>
                    
                    <!-- Needs Attention - Full Width -->
                    <div class="card full-width-card urgent-trials">
                        <div class="card-header">
                            <div class="card-icon">üö®</div>
                            <div class="card-title">Needs Attention</div>
                        </div>
                        <div id="needsAttention">
                            <div class="add-attention-form">
                                <h4 style="margin-bottom: 15px; color: #2d3748;">Add Attention Item</h4>
                                <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 15px; align-items: end;">
                                    <div>
                                        <label class="form-label" style="margin-bottom: 5px;">Who/What:</label>
                                        <input type="text" 
                                               class="form-input" 
                                               id="attention-subject-input" 
                                               placeholder="Customer name, person, or topic..."
                                               list="customer-suggestions-list">
                                        <datalist id="customer-suggestions-list"></datalist>
                                    </div>
                                    <div>
                                        <label class="form-label" style="margin-bottom: 5px;">Reminder:</label>
                                        <input type="text" class="form-input" id="attention-note-input" placeholder="What needs attention? (e.g., 'Talk to Steve about Monday off', 'Call about pricing')">
                                    </div>
                                    <button class="btn btn-small" onclick="addAttentionItem()" style="margin-top: 20px;">+ Add</button>
                                </div>
                                <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px; font-size: 0.85rem; color: #1e40af;">
                                    üí° <strong>Tip:</strong> Type a customer name from your database for customer-specific reminders, or enter anything else for general notes (like "Buy groceries", "Call dentist", etc.)
                                </div>
                            </div>
                            <div id="attentionItems"></div>
                        </div>
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="card recent-activity">
                        <div class="card-header">
                            <div class="card-icon">üîÑ</div>
                            <div class="card-title">Recent Activity</div>
                        </div>
                        <div id="recentActivity" class="loading">
                            Loading recent customer interactions...
                        </div>
                    </div>
                </div>
            `;
        }

        function createAllCustomersContent() {
            return `
                <div class="customer-search-view">
                    <div class="search-header">
                        <h2 style="color: #2d3748; margin-bottom: 15px;">üë• All Customers - Combined View</h2>
                        <p style="color: #718096; margin-bottom: 20px;">All customers and prospects - both hot leads and target leads combined</p>
                        <div class="search-controls">
                            <div class="search-filters">
                                <input type="text" id="allCustomersSearch" placeholder="üîç Search by name, organization, or email..." class="search-input">
                                <select id="allCustomersLeadSourceFilter" class="filter-dropdown">
                                    <option value="">All Lead Types</option>
                                    <option value="inbound_call">Hot Leads (Scheduled Calls)</option>
                                    <option value="target_leads">Target Leads (Cold Outreach)</option>
                                    <option value="notion_import">Existing Customers</option>
                                </select>
                                <select id="allCustomersStatusFilter" class="filter-dropdown">
                                    <option value="">All Status</option>
                                    <option value="new">New</option>
                                    <option value="called">Called</option>
                                    <option value="email_sent">Email Sent</option>
                                    <option value="callback_scheduled">Callback Scheduled</option>
                                    <option value="converted">Converted</option>
                                </select>
                            </div>
                            
                            <div class="sort-buttons">
                                <div class="sort-group">
                                    <span class="sort-label">Name:</span>
                                    <div class="sort-controls">
                                        <button class="sort-btn" id="allCustomersNameAsc" onclick="setAllCustomersSort('customer_name', 'asc')">A‚ÜëZ</button>
                                        <button class="sort-btn" id="allCustomersNameDesc" onclick="setAllCustomersSort('customer_name', 'desc')">Z‚ÜìA</button>
                                    </div>
                                </div>
                                
                                <div class="sort-group">
                                    <span class="sort-label">Last Contact:</span>
                                    <div class="sort-controls">
                                        <button class="sort-btn" id="allCustomersContactAsc" onclick="setAllCustomersSort('updated_at', 'asc')">Old‚Üë</button>
                                        <button class="sort-btn" id="allCustomersContactDesc" onclick="setAllCustomersSort('updated_at', 'desc')">New‚Üì</button>
                                    </div>
                                </div>
                                
                                <button class="btn btn-small" onclick="clearAllCustomersFilters()">üîÑ Clear All</button>
                                <button class="btn btn-small" onclick="addNewCustomer()">‚ûï Add Customer</button>
                            </div>
                        </div>
                    </div>
                    <div class="customer-list" id="allCustomersList">
                        <div class="loading">Loading all customers...</div>
                    </div>
                </div>
            `;
        }

        function createHitListContent() {
            return `
                <div class="customer-search-view">
                    <div class="search-header">
                        <h2 style="color: #2d3748; margin-bottom: 15px;">üî• Hit List - Scheduled Calls & Hot Leads</h2>
                        <p style="color: #718096; margin-bottom: 20px;">Customers who responded to emails, scheduled calls, and have active trials</p>
                        <div class="search-controls">
                            <div class="search-filters">
                                <input type="text" id="hitlistNameSearch" placeholder="üîç Search by name or organization..." class="search-input">
                                <select id="hitlistTrialFilter" class="filter-dropdown">
                                    <option value="">All Trial Status</option>
                                    <option value="expired">Expired Trials</option>
                                    <option value="urgent">Urgent (‚â§7 days)</option>
                                    <option value="warning">Warning (‚â§14 days)</option>
                                    <option value="active">Active (>14 days)</option>
                                </select>
                                <select id="hitlistCallbackFilter" class="filter-dropdown">
                                    <option value="">All Callbacks</option>
                                    <option value="today">Due Today</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="thisweek">This Week</option>
                                    <option value="scheduled">Scheduled</option>
                                </select>
                            </div>
                            
                            <div class="sort-buttons">
                                <div class="sort-group">
                                    <span class="sort-label">Trial End:</span>
                                    <div class="sort-controls">
                                        <button class="sort-btn" id="hitlistTrialAsc" onclick="setHitlistSort('trial_expiration_date', 'asc')">Soon‚Üë</button>
                                        <button class="sort-btn" id="hitlistTrialDesc" onclick="setHitlistSort('trial_expiration_date', 'desc')">Late‚Üì</button>
                                    </div>
                                </div>
                                
                                <div class="sort-group">
                                    <span class="sort-label">Callback:</span>
                                    <div class="sort-controls">
                                        <button class="sort-btn" id="hitlistCallbackAsc" onclick="setHitlistSort('next_callback_date', 'asc')">Soon‚Üë</button>
                                        <button class="sort-btn" id="hitlistCallbackDesc" onclick="setHitlistSort('next_callback_date', 'desc')">Late‚Üì</button>
                                    </div>
                                </div>
                                
                                <button class="btn btn-small" onclick="clearHitlistFilters()">üîÑ Clear All</button>
                                <button class="btn btn-small" onclick="addNewHotLead()">‚ûï Add Hot Lead</button>
                            </div>
                        </div>
                    </div>
                    <div class="customer-list" id="hitlistCustomerList">
                        <div class="loading">Loading hot leads and scheduled calls...</div>
                    </div>
                </div>
            `;
        }

        function createTargetLeadsContent() {
            return `
                <div class="customer-search-view">
                    <div class="search-header">
                        <h2 style="color: #2d3748; margin-bottom: 15px;">üìß Target Leads - Cold Outreach</h2>
                        <p style="color: #718096; margin-bottom: 20px;">Prospects who haven't responded yet - focus on getting appointments scheduled</p>
                        <div class="search-controls">
                            <div class="search-filters">
                                <input type="text" id="targetleadsSearch" placeholder="üîç Search by organization or email..." class="search-input">
                                <select id="targetleadsContactFilter" class="filter-dropdown">
                                    <option value="">All Contact Status</option>
                                    <option value="never">Never Contacted</option>
                                    <option value="recent">Contacted Recently</option>
                                    <option value="followup">Needs Follow-up</option>
                                    <option value="responded">Responded (Move to Hit List!)</option>
                                </select>
                                <select id="targetleadsIndustryFilter" class="filter-dropdown">
                                    <option value="">All Industries</option>
                                    <option value="nonprofit">Nonprofit</option>
                                    <option value="association">Association</option>
                                    <option value="government">Government</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="sort-buttons">
                                <div class="sort-group">
                                    <span class="sort-label">Last Contact:</span>
                                    <div class="sort-controls">
                                        <button class="sort-btn" id="targetContactAsc" onclick="setTargetSort('updated_at', 'asc')">Old‚Üë</button>
                                        <button class="sort-btn" id="targetContactDesc" onclick="setTargetSort('updated_at', 'desc')">New‚Üì</button>
                                    </div>
                                </div>
                                
                                <div class="sort-group">
                                    <span class="sort-label">Organization:</span>
                                    <div class="sort-controls">
                                        <button class="sort-btn" id="targetOrgAsc" onclick="setTargetSort('organization_name', 'asc')">A‚ÜëZ</button>
                                        <button class="sort-btn" id="targetOrgDesc" onclick="setTargetSort('organization_name', 'desc')">Z‚ÜìA</button>
                                    </div>
                                </div>
                                
                                <button class="btn btn-small" onclick="clearTargetFilters()">üîÑ Clear All</button>
                                <button class="btn btn-small" onclick="addNewTargetLead()">‚ûï Add Target Lead</button>
                            </div>
                        </div>
                    </div>
                    <div class="customer-list" id="targetleadsCustomerList">
                        <div class="loading">Loading target leads for outreach...</div>
                    </div>
                </div>
            `;
        }

        function createReportsContent() {
            return `
                <div class="reports-view">
                    <div class="reports-header">
                        <h2 class="reports-title">üìä Customer Activity Analytics</h2>
                        <div class="reports-controls">
                            <select class="filter-dropdown">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="all">All time</option>
                            </select>
                            <button class="btn btn-small">üì§ Export Report</button>
                        </div>
                    </div>
                    
                    <div class="reports-grid">
                        <!-- Key Metrics Row -->
                        <div class="metrics-row">
                            <div class="metric-card">
                                <div class="metric-icon">üìû</div>
                                <div class="metric-content">
                                    <div class="metric-value">18</div>
                                    <div class="metric-label">Callbacks Completed</div>
                                    <div class="metric-change positive">+12% vs last period</div>
                                </div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon">‚è±Ô∏è</div>
                                <div class="metric-content">
                                    <div class="metric-value">2.3 hrs</div>
                                    <div class="metric-label">Avg Response Time</div>
                                    <div class="metric-change negative">+0.5hr vs last period</div>
                                </div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon">‚úÖ</div>
                                <div class="metric-content">
                                    <div class="metric-value">73%</div>
                                    <div class="metric-label">Callback Success Rate</div>
                                    <div class="metric-change positive">+8% vs last period</div>
                                </div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-icon">üìà</div>
                                <div class="metric-content">
                                    <div class="metric-value">11</div>
                                    <div class="metric-label">Customers Converted</div>
                                    <div class="metric-change positive">+3 vs last period</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts and other content... -->
                    </div>
                </div>
            `;
        }

        // Split customers into hit list vs target leads
        function splitCustomersByLeadSource() {
            hitListCustomers = allCustomers.filter(customer => 
                customer.lead_source === 'inbound_call' || customer.lead_source === 'notion_import'
            );
            
            targetLeadsCustomers = allCustomers.filter(customer => 
                customer.lead_source === 'target_leads'
            );
            
            filteredHitList = [...hitListCustomers];
            filteredTargetLeads = [...targetLeadsCustomers];
            filteredAllCustomers = [...allCustomers];
            
            console.log(`Split customers: ${hitListCustomers.length} hot leads, ${targetLeadsCustomers.length} target leads, ${allCustomers.length} total`);
        }

        // Customer tab management (for edit tabs only)
        function switchTab(tabName) {
            // Handle dashboard specially
            if (tabName === 'dashboard') {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active from all tab buttons
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });
                
                // Show dashboard and make its button active
                document.getElementById('dashboard-tab').classList.add('active');
                document.getElementById('tab-dashboard').classList.add('active');
                
                // Make sure we're in dashboard view
                currentView = 'dashboard';
                
                // Reload dashboard content
                const dashboardTab = document.getElementById('dashboard-tab');
                dashboardTab.innerHTML = createDashboardContent();
                loadDashboardData();
                
                activeTab = 'dashboard';
                return;
            }
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            
            activeTab = tabName;
        }

        function closeTab(tabId, event) {
            event.stopPropagation();
            
            // Don't close the main dashboard tab
            if (tabId === 'dashboard') return;
            
            // Remove tab button and content
            document.getElementById('tab-' + tabId).remove();
            document.getElementById(tabId + '-tab').remove();
            
            // Remove from open tabs
            openTabs = openTabs.filter(tab => tab !== tabId);
            
            // Switch to dashboard if this was active tab
            if (activeTab === tabId) {
                switchTab('dashboard');
            }
        }

        function openCustomerTab(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;
            
            const tabId = `customer-${customerId}`;
            const tabName = customer.customer_name.length > 20 ? 
                customer.customer_name.substring(0, 20) + '...' : 
                customer.customer_name;
            
            // Check if tab already exists
            if (document.getElementById(tabId + '-tab')) {
                switchTab(tabId);
                return;
            }
            
            // Create new tab button
            const tabButton = document.createElement('button');
            tabButton.className = 'tab-button';
            tabButton.id = 'tab-' + tabId;
            tabButton.onclick = () => switchTab(tabId);
            tabButton.innerHTML = `
                ‚úèÔ∏è ${tabName}
                <span class="close-btn" onclick="closeTab('${tabId}', event)">√ó</span>
            `;
            
            document.querySelector('.tab-navigation').appendChild(tabButton);
            
            // Create tab content
            const tabContent = document.createElement('div');
            tabContent.id = tabId + '-tab';
            tabContent.className = 'tab-content';
            tabContent.innerHTML = createCustomerEditForm(customer);
            
            document.querySelector('.container').appendChild(tabContent);
            
            // Switch to new tab
            switchTab(tabId);
            openTabs.push(tabId);
        }

        function createCustomerEditForm(customer) {
            return `
                <div class="customer-edit-view">
                    <div class="edit-header">
                        <h2 class="edit-title">${customer.customer_name}</h2>
                        <p class="edit-subtitle">${customer.organization_name || 'No organization'}</p>
                    </div>
                    
                    <div id="customer-form-${customer.id}">
                        <div class="form-grid">
                            <!-- Contact Information -->
                            <div class="form-section">
                                <h3 class="section-title">üìû Contact Information</h3>
                                
                                <div class="form-group">
                                    <label class="form-label">Customer Name</label>
                                    <input type="text" class="form-input" value="${customer.customer_name}" name="customer_name" id="name-${customer.id}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-input" value="${customer.email_address}" name="email_address" id="email-${customer.id}" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Phone Number</label>
                                    <input type="text" class="form-input" value="${customer.phone_number || ''}" name="phone_number" id="phone-${customer.id}">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Organization</label>
                                    <input type="text" class="form-input" value="${customer.organization_name || ''}" name="organization_name" id="org-${customer.id}">
                                </div>
                            </div>
                            
                            <!-- Business Information -->
                            <div class="form-section">
                                <h3 class="section-title">üíº Business Information</h3>
                                
                                <div class="form-group">
                                    <label class="form-label">Call Status</label>
                                    <select class="form-select" name="call_status" id="status-${customer.id}">
                                        <option value="new" ${customer.call_status === 'new' ? 'selected' : ''}>New</option>
                                        <option value="called" ${customer.call_status === 'called' ? 'selected' : ''}>Called</option>
                                        <option value="email_sent" ${customer.call_status === 'email_sent' ? 'selected' : ''}>Email Sent</option>
                                        <option value="callback_scheduled" ${customer.call_status === 'callback_scheduled' ? 'selected' : ''}>Callback Scheduled</option>
                                        <option value="converted" ${customer.call_status === 'converted' ? 'selected' : ''}>Converted</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Next Callback Date</label>
                                    <input type="date" class="form-input" value="${customer.next_callback_date || ''}" name="next_callback_date" id="callback-date-${customer.id}">
                                    <small style="color: #718096; font-size: 0.8rem; margin-top: 5px; display: block;">
                                        üìÖ This will appear in "Today's Callbacks" when the date arrives
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Callback Reason</label>
                                    <input type="text" class="form-input" value="${customer.callback_reason || ''}" name="callback_reason" id="callback-reason-${customer.id}" placeholder="Why are you calling them back? (e.g., 'Discuss pricing options', 'Follow up on trial questions')">
                                    <small style="color: #718096; font-size: 0.8rem; margin-top: 5px; display: block;">
                                        üí° This helps you prepare for the call and prioritize your day
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Industry Type</label>
                                    <input type="text" class="form-input" value="${customer.industry_type || ''}" name="industry_type" id="industry-${customer.id}">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Lead Source</label>
                                    <select class="form-select" name="lead_source" id="source-${customer.id}">
                                        <option value="inbound_call" ${customer.lead_source === 'inbound_call' ? 'selected' : ''}>Inbound Call</option>
                                        <option value="target_leads" ${customer.lead_source === 'target_leads' ? 'selected' : ''}>Target Leads</option>
                                        <option value="notion_import" ${customer.lead_source === 'notion_import' ? 'selected' : ''}>Notion Import</option>
                                        <option value="referral" ${customer.lead_source === 'referral' ? 'selected' : ''}>Referral</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Call Outcome</label>
                                    <textarea class="form-textarea" name="call_outcome" id="outcome-${customer.id}">${customer.call_outcome || ''}</textarea>
                                </div>
                            </div>
                            
                            <!-- System Links -->
                            <div class="form-section">
                                <h3 class="section-title">üîó System Links</h3>
                                
                                <div class="form-group">
                                    <label class="form-label">ZenDesk URL</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="url" class="form-input" value="${customer.zendesk_url || ''}" name="zendesk_url" id="zendesk-${customer.id}" style="flex: 1;">
                                        ${customer.zendesk_url ? `<a href="${customer.zendesk_url}" target="_blank" class="btn btn-small" style="white-space: nowrap;">üîó Open</a>` : ''}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">HubSpot URL</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="url" class="form-input" value="${customer.hubspot_url || ''}" name="hubspot_url" id="hubspot-${customer.id}" style="flex: 1;">
                                        ${customer.hubspot_url ? `<a href="${customer.hubspot_url}" target="_blank" class="btn btn-small" style="white-space: nowrap;">üîó Open</a>` : ''}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Wild Apricot Site</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="url" class="form-input" value="${customer.wildapricot_site_url || ''}" name="wildapricot_site_url" id="wildapricot-${customer.id}" style="flex: 1;">
                                        ${customer.wildapricot_site_url ? `<a href="${customer.wildapricot_site_url}" target="_blank" class="btn btn-small" style="white-space: nowrap;">üîó Open</a>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Trial Information -->
                            <div class="form-section">
                                <h3 class="section-title">üìä Trial Information</h3>
                                
                                <div class="form-group">
                                    <label class="form-label">Trial Expiration Date</label>
                                    <input type="date" class="form-input" value="${customer.trial_expiration_date || ''}" name="trial_expiration_date" id="trial-date-${customer.id}">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Days Remaining</label>
                                    <input type="number" class="form-input" value="${customer.trial_days_remaining || ''}" name="trial_days_remaining" id="trial-days-${customer.id}" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button type="button" class="btn btn-primary" onclick="saveCustomerData(${customer.id})" id="save-btn-${customer.id}">üíæ Save Changes</button>
                            <button type="button" class="btn btn-secondary" onclick="switchView('dashboard')">Cancel</button>
                            <button type="button" class="btn btn-danger" onclick="deleteCustomer(${customer.id})">üóëÔ∏è Delete Customer</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // New save function that works without form submission
        function saveCustomerData(customerId) {
            console.log('Saving customer:', customerId);
            
            try {
                // Get all the input values directly by ID
                const customerData = {
                    customer_name: document.getElementById(`name-${customerId}`).value,
                    email_address: document.getElementById(`email-${customerId}`).value,
                    phone_number: document.getElementById(`phone-${customerId}`).value,
                    organization_name: document.getElementById(`org-${customerId}`).value,
                    call_status: document.getElementById(`status-${customerId}`).value,
                    next_callback_date: document.getElementById(`callback-date-${customerId}`).value,
                    callback_reason: document.getElementById(`callback-reason-${customerId}`).value,
                    industry_type: document.getElementById(`industry-${customerId}`).value,
                    lead_source: document.getElementById(`source-${customerId}`).value,
                    call_outcome: document.getElementById(`outcome-${customerId}`).value,
                    zendesk_url: document.getElementById(`zendesk-${customerId}`).value,
                    hubspot_url: document.getElementById(`hubspot-${customerId}`).value,
                    wildapricot_site_url: document.getElementById(`wildapricot-${customerId}`).value,
                    trial_expiration_date: document.getElementById(`trial-date-${customerId}`).value,
                    trial_days_remaining: document.getElementById(`trial-days-${customerId}`).value,
                    updated_at: new Date().toISOString()
                };
                
                console.log('Collected data:', customerData);
                
                // Find and update customer
                const customerIndex = allCustomers.findIndex(c => c.id == customerId);
                
                if (customerIndex !== -1) {
                    // Store old data for comparison
                    const oldCustomer = {...allCustomers[customerIndex]};
                    
                    // Update customer data
                    allCustomers[customerIndex] = {
                        ...allCustomers[customerIndex],
                        ...customerData,
                        id: parseInt(customerId)
                    };
                    
                    console.log('Updated customer:', allCustomers[customerIndex]);
                    
                    // Re-split data since lead_source might have changed
                    splitCustomersByLeadSource();
                    
                    // Visual feedback
                    const saveButton = document.getElementById(`save-btn-${customerId}`);
                    if (saveButton) {
                        const originalText = saveButton.innerHTML;
                        const originalColor = saveButton.style.background;
                        
                        saveButton.innerHTML = '‚úÖ SAVED!';
                        saveButton.style.background = '#48bb78';
                        
                        setTimeout(() => {
                            saveButton.innerHTML = originalText;
                            saveButton.style.background = originalColor;
                        }, 2000);
                    }
                    
                    // Update tab title if name changed
                    if (customerData.customer_name !== oldCustomer.customer_name) {
                        const tabButton = document.getElementById(`tab-customer-${customerId}`);
                        if (tabButton) {
                            const shortName = customerData.customer_name.length > 20 ? 
                                customerData.customer_name.substring(0, 20) + '...' : 
                                customerData.customer_name;
                            tabButton.innerHTML = `
                                ‚úèÔ∏è ${shortName}
                                <span class="close-btn" onclick="closeTab('customer-${customerId}', event)">√ó</span>
                            `;
                        }
                        
                        // Update the header in the edit form
                        const titleElement = document.querySelector(`#customer-${customerId}-tab .edit-title`);
                        if (titleElement) {
                            titleElement.textContent = customerData.customer_name;
                        }
                    }
                    
                    // Show success message
                    alert(`‚úÖ Customer "${customerData.customer_name}" saved successfully!`);
                    
                    // Refresh other views
                    refreshDashboard();
                    
                } else {
                    console.error('Customer not found with ID:', customerId);
                    alert('‚ùå Error: Customer not found');
                }
                
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ùå Error saving customer: ' + error.message);
            }
        }

        function deleteCustomer(customerId) {
            if (confirm('Are you sure you want to delete this customer?')) {
                // Remove from memory (will be replaced with Supabase sync)
                allCustomers = allCustomers.filter(c => c.id !== customerId);
                
                // Re-split the data
                splitCustomersByLeadSource();
                
                // Close the tab
                closeTab(`customer-${customerId}`, {stopPropagation: () => {}});
                
                alert('Customer deleted successfully!');
                
                // Refresh displays
                refreshDashboard();
            }
        }

        // Search and filter functions (simplified for space)
        function setupSearchHandlers() {
    // Set up handlers for all possible filter dropdowns across all views
    setupFilterHandlers('hitlist');
    setupFilterHandlers('targetleads'); 
    setupFilterHandlers('allCustomers');
}

function setupFilterHandlers(viewType) {
    const searchInput = document.getElementById(viewType + 'Search') || 
                       document.getElementById(viewType + 'NameSearch');
    const trialFilter = document.getElementById(viewType + 'TrialFilter');
    const callbackFilter = document.getElementById(viewType + 'CallbackFilter');
    const statusFilter = document.getElementById(viewType + 'StatusFilter');
    const sourceFilter = document.getElementById(viewType + 'LeadSourceFilter');
    
    if (searchInput) {
        searchInput.removeEventListener('input', handleSearch);
        searchInput.addEventListener('input', handleSearch);
    }
    if (trialFilter) {
        trialFilter.removeEventListener('change', handleTrialFilter);
        trialFilter.addEventListener('change', handleTrialFilter);
    }
    if (callbackFilter) {
        callbackFilter.removeEventListener('change', handleCallbackFilter);
        callbackFilter.addEventListener('change', handleCallbackFilter);
    }
    if (statusFilter) {
        statusFilter.removeEventListener('change', handleStatusFilter);
        statusFilter.addEventListener('change', handleStatusFilter);
    }
    if (sourceFilter) {
        sourceFilter.removeEventListener('change', handleSourceFilter);
        sourceFilter.addEventListener('change', handleSourceFilter);
    }
}

        function handleNameSearch() {
            nameSearchTerm = document.getElementById('customerNameSearch').value.toLowerCase();
            applyAllFilters();
        }

        function handleTrialFilter() {
    console.log('Trial filter clicked:', document.getElementById('hitlistTrialFilter').value);
    trialDateFilter = document.getElementById('hitlistTrialFilter').value;
    applyAllFilters();
}

        function handleContactFilter() {
            lastContactFilter = document.getElementById('lastContactFilter').value;
            applyAllFilters();
        }

        function applyAllFilters() {
    // Get current filter values - use correct IDs based on current view
    const currentTrialFilter = document.getElementById('hitlistTrialFilter')?.value || '';
    const currentCallbackFilter = document.getElementById('hitlistCallbackFilter')?.value || '';
    const currentNameSearch = document.getElementById('hitlistNameSearch')?.value?.toLowerCase() || '';
    
    filteredHitList = hitListCustomers.filter(customer => {
        // Name/organization search
        const matchesName = !currentNameSearch || 
            customer.customer_name.toLowerCase().includes(currentNameSearch) ||
            (customer.organization_name && customer.organization_name.toLowerCase().includes(currentNameSearch));
        
        // Trial status filter
        let matchesTrial = true;
        if (currentTrialFilter) {
            const daysLeft = customer.trial_days_remaining;
            switch(currentTrialFilter) {
                case 'expired':
                    matchesTrial = daysLeft <= 0;
                    break;
                case 'urgent':
                    matchesTrial = daysLeft > 0 && daysLeft <= 7;
                    break;
                case 'warning':
                    matchesTrial = daysLeft > 7 && daysLeft <= 14;
                    break;
                case 'active':
                    matchesTrial = daysLeft > 14;
                    break;
            }
        }
        
        // Callback filter
        let matchesCallback = true;
        if (currentCallbackFilter) {
            const today = getTodayLocalDate();
            const callbackDate = customer.next_callback_date;
            switch(currentCallbackFilter) {
                case 'today':
                    matchesCallback = callbackDate === today;
                    break;
                case 'overdue':
                    matchesCallback = callbackDate && callbackDate < today;
                    break;
                case 'thisweek':
                    // Simple week check - you can make this more sophisticated
                    matchesCallback = callbackDate && callbackDate >= today;
                    break;
                case 'scheduled':
                    matchesCallback = !!callbackDate;
                    break;
            }
        }
        
        return matchesName && matchesTrial && matchesCallback;
    });
    
    displayHitList();
}

        function setSingleSort(field, direction) {
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            
            currentSortField = field;
            currentSortDirection = direction;
            
            const buttonMap = {
                'customer_nameAsc': 'nameAsc',
                'customer_nameDesc': 'nameDesc',
                'trial_expiration_dateAsc': 'trialAsc',
                'trial_expiration_dateDesc': 'trialDesc',
                'updated_atAsc': 'contactAsc',
                'updated_atDesc': 'contactDesc'
            };
            
            const buttonId = buttonMap[field + (direction === 'asc' ? 'Asc' : 'Desc')];
            if (buttonId) {
                document.getElementById(buttonId).classList.add('active');
            }
            
            sortCustomers();
            displayCustomerList();
        }

        function clearAllFilters() {
            document.getElementById('customerNameSearch').value = '';
            document.getElementById('trialDateFilter').value = '';
            document.getElementById('lastContactFilter').value = '';
            
            nameSearchTerm = '';
            trialDateFilter = '';
            lastContactFilter = '';
            currentSortField = null;
            
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            
            filteredCustomers = [...allCustomers];
            displayCustomerList();
        }

        function sortCustomers() {
            if (!currentSortField) return;
            
            filteredCustomers.sort((a, b) => {
                let aVal = a[currentSortField];
                let bVal = b[currentSortField];
                
                if (!aVal && !bVal) return 0;
                if (!aVal) return currentSortDirection === 'asc' ? 1 : -1;
                if (!bVal) return currentSortDirection === 'asc' ? -1 : 1;
                
                if (currentSortField.includes('date') || currentSortField === 'updated_at') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                if (currentSortField === 'customer_name') {
                    aVal = aVal.toString().toLowerCase();
                    bVal = bVal.toString().toLowerCase();
                }
                
                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                if (aVal < bVal) comparison = -1;
                
                return currentSortDirection === 'asc' ? comparison : -comparison;
            });
        }

        // Dashboard functions
        function loadDashboardData() {
            loadTodaysCallbacks();
            loadNeedsAttention();
            loadRecentActivity();
            populateCustomerSuggestions();
        }

        // Populate customer suggestions for attention items
        function populateCustomerSuggestions() {
            const datalist = document.getElementById('customer-suggestions-list');
            if (!datalist) return;
            
            // Clear existing options
            datalist.innerHTML = '';
            
            // Add all customer names as options
            allCustomers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.customer_name;
                option.textContent = `${customer.customer_name} (${customer.organization_name || customer.email_address})`;
                datalist.appendChild(option);
            });
        }

        // Attention items storage (will be replaced with Supabase)
        let attentionItems = [
            {
                id: 1,
                customerId: 28,
                subject: "Kaylie Lake",
                note: "Call manager about DNS pointing issue - customer confused",
                dateAdded: "2025-06-18"
            }
        ];

        function loadTodaysCallbacks() {
            const today = getTodayLocalDate();
            console.log('Today (local timezone):', today);
            
            const todaysCustomers = allCustomers.filter(customer => {
                console.log(`Checking customer ${customer.customer_name}: callback date = ${customer.next_callback_date}`);
                return customer.next_callback_date === today;
            });

            console.log('Found callbacks for today:', todaysCustomers.length);

            const container = document.getElementById('todaysCallbacks');
            
            if (todaysCustomers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #718096;">
                        <p>üìû No callbacks scheduled for today (${today})</p>
                        <p style="font-size: 0.9rem; margin-top: 8px;">Schedule callbacks in customer details to see them here</p>
                    </div>
                `;
                return;
            }

            const tableRows = todaysCustomers.map(customer => `
                <tr>
                    <td>
                        <div class="callback-customer-name" onclick="openCustomerTab(${customer.id})">${customer.customer_name}</div>
                        <div class="callback-org-small">${customer.organization_name || customer.email_address}</div>
                    </td>
                    <td class="callback-reason-small" title="${customer.callback_reason || 'No reason specified'}">
                        ${customer.callback_reason || 'No reason specified - add one in customer details'}
                    </td>
                    <td style="text-align: center;">
                        <button class="btn-done" onclick="markCallComplete(${customer.id})" title="Mark callback as complete">‚úì</button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
                <table class="callback-table">
                    <thead>
                        <tr>
                            <th style="width: 250px;">Customer</th>
                            <th>Reason for Call</th>
                            <th style="width: 60px; text-align: center;">Done</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        function markCallComplete(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (customer) {
                // Clear the callback date and update status
                const customerIndex = allCustomers.findIndex(c => c.id === customerId);
                allCustomers[customerIndex].next_callback_date = null;
                allCustomers[customerIndex].call_status = 'called';
                allCustomers[customerIndex].updated_at = new Date().toISOString();
                
                // Refresh dashboard
                loadTodaysCallbacks();
                
                alert(`‚úÖ Callback completed for ${customer.customer_name}`);
            }
        }

        function loadNeedsAttention() {
            const container = document.getElementById('attentionItems');
            
            if (attentionItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #718096; font-style: italic;">
                        No items need attention right now. Add reminders or important notes above.
                    </div>
                `;
                return;
            }

            const html = attentionItems.map(item => {
                // Use the subject field if available, otherwise fall back to customerName for old items
                const displaySubject = item.subject || (item.customerId ? allCustomers.find(c => c.id == item.customerId)?.customer_name : 'General Note') || 'General Note';
                
                return `
                    <div class="attention-item" style="display: grid; grid-template-columns: 150px 1fr auto; gap: 15px; align-items: center; padding: 15px 0; border-bottom: 1px solid #f0f4f8;">
                        <div style="font-weight: 600; color: #2d3748; font-size: 0.9rem;">${displaySubject}</div>
                        <div style="color: #4a5568; background: #fef5e7; padding: 10px 15px; border-radius: 8px; border-left: 4px solid #dd6b20;">${item.note}</div>
                        <button class="btn btn-small" onclick="removeAttentionItem(${item.id})" style="background: #e53e3e; color: white; font-size: 0.8rem; padding: 6px 10px;">‚úì Done</button>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function addAttentionItem() {
            const subjectInput = document.getElementById('attention-subject-input');
            const noteInput = document.getElementById('attention-note-input');
            
            const subject = subjectInput.value.trim();
            const note = noteInput.value.trim();
            
            if (!subject || !note) {
                alert('Please enter both who/what and the reminder note');
                return;
            }
            
            // Check if this is a customer name from our database
            const matchingCustomer = allCustomers.find(c => 
                c.customer_name.toLowerCase() === subject.toLowerCase()
            );
            
            // Add new attention item
            const newItem = {
                id: Date.now(),
                customerId: matchingCustomer ? matchingCustomer.id : null,
                subject: subject,
                note: note,
                dateAdded: getTodayLocalDate()
            };
            
            attentionItems.push(newItem);
            
            // Clear form
            subjectInput.value = '';
            noteInput.value = '';
            
            // Refresh display
            loadNeedsAttention();
        }

        function removeAttentionItem(itemId) {
            attentionItems = attentionItems.filter(item => item.id !== itemId);
            loadNeedsAttention();
        }

        function loadRecentActivity() {
            const recentCustomers = [...allCustomers]
                .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
                .slice(0, 5);

            const container = document.getElementById('recentActivity');
            
            const html = recentCustomers.map(customer => {
                const updateDate = new Date(customer.updated_at).toLocaleDateString();
                return `
                    <div class="customer-item">
                        <div class="customer-info">
                            <h4>${customer.customer_name}</h4>
                            <p>Updated: ${updateDate} - ${customer.call_status.replace('_', ' ')}</p>
                        </div>
                        <div>
                            <button class="btn btn-small" onclick="openCustomerTab(${customer.id})">Edit</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function loadAllCustomers() {
            filteredAllCustomers = [...allCustomers];
            displayAllCustomers();
        }

        function loadHitList() {
            filteredHitList = [...hitListCustomers];
            displayHitList();
        }

        function loadTargetLeads() {
            filteredTargetLeads = [...targetLeadsCustomers];
            displayTargetLeads();
        }

        function displayHitList() {
            const container = document.getElementById('hitlistCustomerList');
            
            if (filteredHitList.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">No hot leads found</p>';
                return;
            }

            const tableRows = filteredHitList.map(customer => {
                const lastContact = customer.updated_at ? new Date(customer.updated_at).toLocaleDateString() : 'Never';
                const trialEnd = customer.trial_expiration_date ? new Date(customer.trial_expiration_date).toLocaleDateString() : 'N/A';
                const callbackDate = customer.next_callback_date ? new Date(customer.next_callback_date).toLocaleDateString() : 'Not set';
                const callbackReason = customer.callback_reason || '-';
                const trialDays = customer.trial_days_remaining;
                
                // Determine trial urgency class
                let trialClass = 'normal';
                let trialText = trialDays || 'N/A';
                
                if (trialDays !== null && trialDays !== undefined) {
                    if (trialDays <= 0) {
                        trialClass = 'urgent';
                        trialText = 'Expired';
                    } else if (trialDays <= 7) {
                        trialClass = 'urgent';
                        trialText = `${trialDays} days`;
                    } else if (trialDays <= 14) {
                        trialClass = 'warning';
                        trialText = `${trialDays} days`;
                    } else {
                        trialClass = 'normal';
                        trialText = `${trialDays} days`;
                    }
                }
                
                // Highlight callback date if it's today or past due
                let callbackClass = '';
                if (customer.next_callback_date) {
                    const today = getTodayLocalDate();
                    const callbackDateString = customer.next_callback_date;
                    if (callbackDateString <= today) {
                        callbackClass = 'style="background: #fef5e7; font-weight: 600; color: #dd6b20;"';
                    }
                }
                
                return `
                    <tr onclick="openCustomerTab(${customer.id})">
                        <td>
                            <div class="table-customer-name">${customer.customer_name}</div>
                            <div class="table-organization">${customer.organization_name || 'No organization'}</div>
                        </td>
                        <td>
                            <div class="table-email">${customer.email_address}</div>
                        </td>
                        <td>
                            <div class="table-status">
                                <span class="status-indicator status-${customer.call_status.replace('_', '-')}"></span>
                                ${customer.call_status.replace('_', ' ')}
                            </div>
                        </td>
                        <td ${callbackClass}>
                            <div class="table-date">${callbackDate}</div>
                            <div class="table-organization" style="font-style: italic; font-size: 0.8rem;">${callbackReason}</div>
                        </td>
                        <td>
                            <div class="table-date">${trialEnd}</div>
                        </td>
                        <td>
                            <span class="table-trial-badge ${trialClass}">${trialText}</span>
                        </td>
                        <td>
                            <div class="table-date">${lastContact}</div>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="customer-table">
                    <thead>
                        <tr>
                            <th>Customer & Organization</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Next Callback & Reason</th>
                            <th>Trial End</th>
                            <th>Days Left</th>
                            <th>Last Contact</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        function displayTargetLeads() {
            const container = document.getElementById('targetleadsCustomerList');
            
            if (filteredTargetLeads.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">No target leads found</p>';
                return;
            }

            const tableRows = filteredTargetLeads.map(customer => {
                const lastContact = customer.updated_at ? new Date(customer.updated_at).toLocaleDateString() : 'Never';
                const daysSinceContact = customer.updated_at ? 
                    Math.floor((new Date() - new Date(customer.updated_at)) / (1000 * 60 * 60 * 24)) : null;
                
                // Determine outreach urgency
                let contactClass = '';
                let contactText = lastContact;
                if (daysSinceContact !== null) {
                    if (daysSinceContact > 14) {
                        contactClass = 'style="background: #fed7d7; color: #742a2a; font-weight: 600;"';
                        contactText = `${daysSinceContact} days ago`;
                    } else if (daysSinceContact > 7) {
                        contactClass = 'style="background: #fef5e7; color: #744210; font-weight: 600;"';
                        contactText = `${daysSinceContact} days ago`;
                    } else {
                        contactText = `${daysSinceContact} days ago`;
                    }
                }
                
                return `
                    <tr onclick="openCustomerTab(${customer.id})">
                        <td>
                            <div class="table-customer-name">${customer.customer_name}</div>
                        </td>
                        <td>
                            <div class="table-organization">${customer.organization_name || 'Unknown organization'}</div>
                        </td>
                        <td>
                            <div class="table-email">${customer.email_address}</div>
                        </td>
                        <td>
                            <div class="table-organization">${customer.industry_type || 'Unknown'}</div>
                        </td>
                        <td>
                            <div class="table-status">
                                <span class="status-indicator status-${customer.call_status.replace('_', '-')}"></span>
                                ${customer.call_status.replace('_', ' ')}
                            </div>
                        </td>
                        <td ${contactClass}>
                            <div class="table-date">${contactText}</div>
                        </td>
                        <td>
                            <div class="table-organization" style="font-style: italic;">${customer.follow_up_1_notes ? customer.follow_up_1_notes.substring(0, 50) + '...' : 'No notes'}</div>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="customer-table">
                    <thead>
                        <tr>
                            <th>Contact Name</th>
                            <th>Organization</th>
                            <th>Email</th>
                            <th>Industry</th>
                            <th>Outreach Status</th>
                            <th>Last Contact</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        function displayAllCustomers() {
            const container = document.getElementById('allCustomersList');
            
            if (filteredAllCustomers.length === 0) {
                container.innerHTML = '<p style="color: #718096; text-align: center; padding: 40px;">No customers found</p>';
                return;
            }

            const tableRows = filteredAllCustomers.map(customer => {
                const lastContact = customer.updated_at ? new Date(customer.updated_at).toLocaleDateString() : 'Never';
                const trialEnd = customer.trial_expiration_date ? new Date(customer.trial_expiration_date).toLocaleDateString() : 'N/A';
                const callbackDate = customer.next_callback_date ? new Date(customer.next_callback_date).toLocaleDateString() : 'Not set';
                const trialDays = customer.trial_days_remaining;
                
                // Determine lead type badge
                let leadTypeClass = '';
                let leadTypeText = '';
                if (customer.lead_source === 'inbound_call') {
                    leadTypeClass = 'success-rate high';
                    leadTypeText = 'Hot Lead';
                } else if (customer.lead_source === 'target_leads') {
                    leadTypeClass = 'success-rate medium';
                    leadTypeText = 'Target Lead';
                } else if (customer.lead_source === 'notion_import') {
                    leadTypeClass = 'success-rate low';
                    leadTypeText = 'Existing';
                } else {
                    leadTypeClass = '';
                    leadTypeText = customer.lead_source || 'Unknown';
                }
                
                // Determine trial urgency class
                let trialClass = 'normal';
                let trialText = trialDays || 'N/A';
                
                if (trialDays !== null && trialDays !== undefined) {
                    if (trialDays <= 0) {
                        trialClass = 'urgent';
                        trialText = 'Expired';
                    } else if (trialDays <= 7) {
                        trialClass = 'urgent';
                        trialText = `${trialDays} days`;
                    } else if (trialDays <= 14) {
                        trialClass = 'warning';
                        trialText = `${trialDays} days`;
                    } else {
                        trialClass = 'normal';
                        trialText = `${trialDays} days`;
                    }
                }
                
                // Highlight callback date if it's today or past due
                let callbackClass = '';
                if (customer.next_callback_date) {
                    const today = getTodayLocalDate();
                    const callbackDateString = customer.next_callback_date;
                    if (callbackDateString <= today) {
                        callbackClass = 'style="background: #fef5e7; font-weight: 600; color: #dd6b20;"';
                    }
                }
                
                return `
                    <tr onclick="openCustomerTab(${customer.id})">
                        <td>
                            <div class="table-customer-name">${customer.customer_name}</div>
                            <div class="table-organization">${customer.organization_name || 'No organization'}</div>
                        </td>
                        <td>
                            <div class="table-email">${customer.email_address}</div>
                        </td>
                        <td>
                            <span class="table-trial-badge ${leadTypeClass}">${leadTypeText}</span>
                        </td>
                        <td>
                            <div class="table-status">
                                <span class="status-indicator status-${customer.call_status.replace('_', '-')}"></span>
                                ${customer.call_status.replace('_', ' ')}
                            </div>
                        </td>
                        <td ${callbackClass}>
                            <div class="table-date">${callbackDate}</div>
                        </td>
                        <td>
                            <div class="table-date">${trialEnd}</div>
                        </td>
                        <td>
                            <span class="table-trial-badge ${trialClass}">${trialText}</span>
                        </td>
                        <td>
                            <div class="table-date">${lastContact}</div>
                        </td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="customer-table">
                    <thead>
                        <tr>
                            <th>Customer & Organization</th>
                            <th>Email</th>
                            <th>Lead Type</th>
                            <th>Status</th>
                            <th>Next Callback</th>
                            <th>Trial End</th>
                            <th>Days Left</th>
                            <th>Last Contact</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        // Sort and filter functions for all customers
        function setAllCustomersSort(field, direction) {
            document.querySelectorAll('#allCustomersList .sort-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to correct button
            const buttonId = field === 'customer_name' ? 
                (direction === 'asc' ? 'allCustomersNameAsc' : 'allCustomersNameDesc') :
                (direction === 'asc' ? 'allCustomersContactAsc' : 'allCustomersContactDesc');
            
            const button = document.getElementById(buttonId);
            if (button) button.classList.add('active');
            
            filteredAllCustomers.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                if (!aVal && !bVal) return 0;
                if (!aVal) return direction === 'asc' ? 1 : -1;
                if (!bVal) return direction === 'asc' ? -1 : 1;
                
                if (field === 'updated_at') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (field === 'customer_name') {
                    aVal = aVal.toString().toLowerCase();
                    bVal = bVal.toString().toLowerCase();
                }
                
                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                if (aVal < bVal) comparison = -1;
                
                return direction === 'asc' ? comparison : -comparison;
            });
            
            displayAllCustomers();
        }

        function clearAllCustomersFilters() {
            document.getElementById('allCustomersSearch').value = '';
            document.getElementById('allCustomersLeadSourceFilter').value = '';
            document.getElementById('allCustomersStatusFilter').value = '';
            
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            
            filteredAllCustomers = [...allCustomers];
            displayAllCustomers();
        }

        function addNewHotLead() {
            const newCustomer = {
                id: Date.now(),
                customer_name: 'New Hot Lead',
                email_address: '',
                organization_name: '',
                phone_number: '',
                call_status: 'callback_scheduled',
                lead_source: 'inbound_call',
                updated_at: new Date().toISOString()
            };
            
            allCustomers.push(newCustomer);
            splitCustomersByLeadSource();
            openCustomerTab(newCustomer.id);
        }

        function addNewTargetLead() {
            const newCustomer = {
                id: Date.now(),
                customer_name: 'Lead - New Organization',
                email_address: '',
                organization_name: 'New Organization',
                call_status: 'new',
                lead_source: 'target_leads',
                updated_at: new Date().toISOString()
            };
            
            allCustomers.push(newCustomer);
            splitCustomersByLeadSource();
            openCustomerTab(newCustomer.id);
        }

        // Sort and filter functions for hit list
        function setHitlistSort(field, direction) {
            document.querySelectorAll('#hitlist-tab .sort-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to correct button
            const buttonId = field === 'trial_expiration_date' ? 
                (direction === 'asc' ? 'hitlistTrialAsc' : 'hitlistTrialDesc') :
                (direction === 'asc' ? 'hitlistCallbackAsc' : 'hitlistCallbackDesc');
            
            document.getElementById(buttonId).classList.add('active');
            
            filteredHitList.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                if (!aVal && !bVal) return 0;
                if (!aVal) return direction === 'asc' ? 1 : -1;
                if (!bVal) return direction === 'asc' ? -1 : 1;
                
                if (field.includes('date')) {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                if (aVal < bVal) comparison = -1;
                
                return direction === 'asc' ? comparison : -comparison;
            });
            
            displayHitList();
        }

        // Sort and filter functions for target leads
        function setTargetSort(field, direction) {
            document.querySelectorAll('#targetleads-tab .sort-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to correct button
            const buttonId = field === 'updated_at' ? 
                (direction === 'asc' ? 'targetContactAsc' : 'targetContactDesc') :
                (direction === 'asc' ? 'targetOrgAsc' : 'targetOrgDesc');
            
            document.getElementById(buttonId).classList.add('active');
            
            filteredTargetLeads.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                if (!aVal && !bVal) return 0;
                if (!aVal) return direction === 'asc' ? 1 : -1;
                if (!bVal) return direction === 'asc' ? -1 : 1;
                
                if (field === 'updated_at') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (field === 'organization_name') {
                    aVal = aVal.toString().toLowerCase();
                    bVal = bVal.toString().toLowerCase();
                }
                
                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                if (aVal < bVal) comparison = -1;
                
                return direction === 'asc' ? comparison : -comparison;
            });
            
            displayTargetLeads();
        }

        function clearHitlistFilters() {
            document.getElementById('hitlistNameSearch').value = '';
            document.getElementById('hitlistTrialFilter').value = '';
            document.getElementById('hitlistCallbackFilter').value = '';
            
            document.querySelectorAll('#hitlist-tab .sort-btn').forEach(btn => btn.classList.remove('active'));
            
            filteredHitList = [...hitListCustomers];
            displayHitList();
        }

        function clearTargetFilters() {
            document.getElementById('targetleadsSearch').value = '';
            document.getElementById('targetleadsContactFilter').value = '';
            document.getElementById('targetleadsIndustryFilter').value = '';
            
            document.querySelectorAll('#targetleads-tab .sort-btn').forEach(btn => btn.classList.remove('active'));
            
            filteredTargetLeads = [...targetLeadsCustomers];
            displayTargetLeads();
        }

        // Quick action functions
        function refreshDashboard() {
            console.log('Refreshing dashboard - reloading from database...');
            loadCustomersFromDatabase();
        }

        function addNewCustomer() {
            // Default to adding a hot lead (can be changed in the form)
            addNewHotLead();
        }
    </script>
</body>
</html>
